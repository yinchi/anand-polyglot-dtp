<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DTP Portal</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
      h1 { margin-bottom: 0.25rem; }
      .grid { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); margin-top: 1rem; }
      .card { border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; }
      .card h2 { margin: 0 0 0.5rem 0; font-size: 1.1rem; }
      .card p { margin: 0.25rem 0; color: #334155; }
      a.button { display: inline-block; margin-top: 0.5rem; background: #2563eb; color: #fff; padding: 0.5rem 0.75rem; border-radius: 6px; text-decoration: none; }
      footer { margin-top: 2rem; color: #64748b; font-size: 0.9rem; }
      code { background: #f1f5f9; padding: 0 0.25rem; border-radius: 4px; }
    </style>
  </head>
  <body>
    <h1>Polyglot DTP Portal</h1>
    <p>Quick links to local services and UIs.</p>

    <div class="card" style="margin: 1rem 0;">
      <h2>User Login</h2>
      <form id="loginForm">
        <label>Email <input id="email" type="email" value="demo@example.com" required /></label>
        <label style="margin-left: 1rem;">Password <input id="password" type="password" value="demo12345" required /></label>
        <button type="submit" style="margin-left: 1rem;">Login</button>
        <span id="loginStatus" style="margin-left: 1rem; color: #2563eb;"></span>
      </form>
      <div id="twins" style="margin-top: 0.75rem;"></div>
    </div>

    <div class="card" style="margin: 1rem 0; background: #f8fafc;">
      <h2>Twin Composer</h2>
      <p>Low-code twin orchestration built on Node-RED.</p>
      <a class="button" href="http://localhost:1880" target="_blank" rel="noopener">Open Twin Composer</a>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Neo4j Browser</h2>
        <p>Graph UI for Neo4j.</p>
        <a class="button" href="http://localhost:7474" target="_blank" rel="noopener">Open Neo4j</a>
      </div>
      <div class="card">
        <h2>InfluxDB</h2>
        <p>Time-series UI and Data Explorer.</p>
        <a class="button" href="http://localhost:8086" target="_blank" rel="noopener">Open InfluxDB</a>
      </div>
      <div class="card">
        <h2>MinIO Console</h2>
        <p>S3-compatible object storage UI.</p>
        <a class="button" href="http://localhost:9101" target="_blank" rel="noopener">Open MinIO</a>
      </div>
    </div>

    <footer>
      <p>Portal: http://localhost:8080 Â· MQTT topic: <code>dtp/sensors/room1/temp</code></p>
    </footer>

    <script>
      const apiBase = 'http://localhost:8085';
      const tokenKey = 'dtp_token';

      async function login(email, password){
        const res = await fetch(apiBase + '/api/token/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: email, password })
        });
        if(!res.ok) throw new Error('Login failed');
        const data = await res.json();
        localStorage.setItem(tokenKey, data.access);
        return data.access;
      }

      async function fetchTwins(){
        const token = localStorage.getItem(tokenKey);
        if(!token) return [];
        const res = await fetch(apiBase + '/api/me/twins/', { headers: { 'Authorization': 'Bearer ' + token }});
        if(!res.ok) return [];
        return res.json();
      }

      function renderTwins(list){
        const el = document.getElementById('twins');
        if(!list || list.length === 0){ el.innerHTML = '<em>No twins assigned to this user.</em>'; return; }
        el.innerHTML = '<h3>Your Twins</h3>' + list.map(t => `<div class="card"><strong>${t.name}</strong><br/><a class="button" href="${t.ui_url}" target="_blank" rel="noopener">Open UI</a></div>`).join('');
      }

      document.getElementById('loginForm').addEventListener('submit', async (e) =>{
        e.preventDefault();
        const email = document.getElementById('email').value;
        const pw = document.getElementById('password').value;
        const statusEl = document.getElementById('loginStatus');
        statusEl.textContent = 'Signing in...';
        try{
          await login(email, pw);
          statusEl.textContent = 'Signed in';
          const twins = await fetchTwins();
          renderTwins(twins);
        }catch(err){
          statusEl.textContent = 'Login failed';
        }
      });

      // Auto-load twins if token exists
      (async () => { const twins = await fetchTwins(); renderTwins(twins); })();
    </script>
  </body>
  </html>
