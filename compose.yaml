services:

  # PostgreSQL with TimescaleDB extension
  postgres:
    container_name: postgres
    image: timescale/timescaledb:latest-pg16
    environment:
      POSTGRES_USER: ${PGUSER}
      POSTGRES_PASSWORD: ${PGPASSWORD}
      POSTGRES_DB: ${PGDATABASE}
    ports:
      - "5432:5432"
    volumes:
      - dbdata:/var/lib/postgresql/data
      - ./data-storage/sql:/docker-entrypoint-initdb.d
    restart: unless-stopped
    healthcheck:
      test:
        - "CMD"
        - "pg_isready"
        - "-U"
        - "${PGUSER}"
        - "-d"
        - "${PGDATABASE}"
      # Quick polling during startup (every 3s), then normal checks (every 30s)
      start_period: 30s
      start_interval: 3s
      interval: 30s
      timeout: 3s
      retries: 3

  # Neo4j graph database
  neo4j:
    container_name: neo4j
    image: neo4j:5
    environment:
      NEO4J_AUTH: neo4j/${NEO4J_PASSWORD}
    ports:
      # Web interface at http://localhost:7474/browser/
      - "7474:7474"
      # Server at neo4j://localhost:7687
      - "7687:7687"
    volumes: 
      - "neo4jdata:/data"
    restart: unless-stopped
    healthcheck:
      test:
        - "CMD"
        - "wget"
        - "-q"
        - "--spider"
        - "http://localhost:7474"
      # Quick polling during startup (every 3s), then normal checks (every 30s)
      start_period: 30s
      start_interval: 3s
      interval: 30s
      timeout: 3s
      retries: 3

  # InfluxDB time-series database
  influx:
    container_name: influx
    image: influxdb:2
    ports:
      # InfluxDB web UI at http://localhost:8086
      # API at http://localhost:8086/api/v2/
      - "8086:8086"
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUX_USER}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUX_PASSWORD}
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUX_ORG}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUX_BUCKET}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUX_TOKEN}
    volumes:
      - "influxdata:/var/lib/influxdb2"
    restart: unless-stopped
    healthcheck:
      test:
        - "CMD"
        - "influx"
        - "ping"
      # Quick polling during startup (every 3s), then normal checks (every 30s)
      start_period: 30s
      start_interval: 3s
      interval: 30s
      timeout: 3s
      retries: 3

  # MinIO object storage
  minio:
    container_name: minio
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY}
    ports:
      - "9100:9000"
      # MinIO web console at http://localhost:9101
      - "9101:9001"
    volumes: 
      - "miniodata:/data"
    restart: unless-stopped
    healthcheck:
      test:
        - "CMD"
        - "curl"
        - "-fsSLo"
        - "/dev/null"
        - "http://localhost:9000/minio/health/live"
      # Quick polling during startup (every 3s), then normal checks (every 30s)
      start_period: 30s
      start_interval: 3s
      interval: 30s
      timeout: 3s
      retries: 3

  # MQTT broker
  mqtt:
    container_name: mqtt
    image: eclipse-mosquitto:2
    ports:
      - "1883:1883"
    volumes:
      - ./infrastructure/mqtt/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    restart: unless-stopped
    healthcheck:
      test:
        - "CMD"
        - "mosquitto_sub"
        - "-h"
        - "localhost"
        - "-p"
        - "1883"
        - "-t"
        - "$$SYS/broker/version"
        - "-C"
        - "1"
      # Quick polling during startup (every 3s), then normal checks (every 30s)
      start_period: 30s
      start_interval: 3s
      interval: 30s
      timeout: 3s
      retries: 3


  # simulator:
  #   build: ./data-collection/simulator
  #   env_file:
  #     - ./.env
  #   environment:
  #     - MQTT_BROKER_HOST=mqtt
  #     - MQTT_BROKER_PORT=1883
  #     - PGHOST=db
  #     - PGPORT=5432
  #     - INFLUX_URL=http://influx:8086
  #   depends_on:
  #     - db
  #     - influx
  #     - mqtt
  #   restart: unless-stopped

  # Web portal (static version)
  portal:
    container_name: webportal-nginx
    image: nginx:alpine
    volumes:
      - ./ui/portal/html:/usr/share/nginx/html:ro
    ports:
      - "${PORTAL_HOST_PORT:-8080}:80"
    restart: unless-stopped
    healthcheck:
      test:
        - "CMD"
        - "wget"
        - "-q"
        - "--spider"
        - "http://localhost"
      # Quick polling during startup (every 3s), then normal checks (every 30s)
      start_period: 30s
      start_interval: 3s
      interval: 30s
      timeout: 3s
      retries: 3

  # Django backend API
  django:
    container_name: backend-django
    image: anand-dtp-django:latest
    build:
      context: ./infrastructure/django
      dockerfile: Dockerfile
    environment:
      - DJANGO_DEBUG=1
      - SECRET_KEY=devsecret
      - ALLOWED_HOSTS=*
      - CORS_ORIGINS=http://localhost:8083,http://localhost:8080
      - PGHOST=postgres
      - PGPORT=5432
      - PGUSER=${PGUSER}
      - PGPASSWORD=${PGPASSWORD}
      - PGDATABASE=${PGDATABASE}
      - INFLUX_URL=http://influx:8086
      - INFLUX_ORG=${INFLUX_ORG}
      - INFLUX_BUCKET=${INFLUX_BUCKET}
      - INFLUX_TOKEN=${INFLUX_TOKEN}
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "8085:8000"
    volumes:
      - ./twins:/app/twins_repo:ro
    restart: unless-stopped
    healthcheck:
      test:
        - "CMD"
        - "python"
        - "/app/health.py"
      # Quick polling during startup (every 3s), then normal checks (every 30s)
      start_period: 30s
      start_interval: 3s
      interval: 30s
      timeout: 3s
      retries: 3

  # Web portal (React version)
  reactui:
    container_name: webportal-react
    image: anand-dtp-webportal-react:latest
    build:
      context: ./ui/react
      args:
        # Use same-origin; Nginx proxies /api -> django
        VITE_API_BASE: ""
    ports:
      # React app at http://localhost:8083
      - "8083:80"
    links:
      - django
    restart: unless-stopped
    depends_on:
      django:
        condition: service_healthy
    healthcheck:
      test:
        - "CMD"
        - "wget"
        - "-q"
        - "--spider"
        - "http://localhost"
      # Quick polling during startup (every 3s), then normal checks (every 30s)
      start_period: 30s
      start_interval: 3s
      interval: 30s
      timeout: 3s
      retries: 3

  # Node-RED flow-based programming tool
  node_red:
    container_name: node_red
    image: nodered/node-red:latest
    ports:
      # Node-RED editor at http://localhost:1880
      - "1880:1880"
    volumes:
      - "nodereddata:/data"
      - "./services/node-red/library:/data/lib/flows"
    restart: unless-stopped

  # alert_gateway:
  #   build: ./data-collection/alert_gateway
  #   environment:
  #     - MQTT_BROKER_HOST=mqtt.local
  #     - MQTT_BROKER_PORT=1883
  #     - MQTT_ALERT_TOPIC=dtp/lift/alerts
  #     - CENTRAL_INFLUX_URL=http://influx.local:8086
  #     - INFLUX_ORG=${INFLUX_ORG}
  #     - INFLUX_BUCKET=${INFLUX_BUCKET}
  #     - INFLUX_TOKEN=${INFLUX_TOKEN}
  #     - REGISTRY_URL=http://django:8000/api/registry/public/twins
  #     - TENANT=demo
  #   depends_on:
  #     - mqtt
  #     - influx
  #   restart: unless-stopped

  # Runner container for executing one-off scripts, e.g., tests
  # Use with: docker compose run --rm runner python /app/your_script.py
  runner:
    container_name: script-runner
    image: python:3.11-trixie
    profiles:
      # Prevent automatic startup with 'docker compose up'
      - one-off
    working_dir: /app
    volumes:
      - ./scripts:/app
    env_file:
      - ./.env

networks:
  default:
    name: anand-dtp-network
    driver: bridge
    attachable: true

volumes:
  dbdata:
  neo4jdata:
  influxdata:
  miniodata:
  nodereddata:
